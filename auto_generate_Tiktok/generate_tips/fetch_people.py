import os
import requests
from openai import OpenAI
from dotenv import load_dotenv

# .envã‹ã‚‰ç’°å¢ƒå¤‰æ•°ã‚’èª­ã¿è¾¼ã¿
load_dotenv()
client = OpenAI(api_key=os.getenv("OPENAI_API_KEY"))

def get_wikipedia_content(title, lang="ja"):
    """Wikipediaã‹ã‚‰è¨˜äº‹æœ¬æ–‡ã‚’å–å¾—"""
    endpoint = f"https://{lang}.wikipedia.org/w/api.php"
    params = {
        "action": "query",
        "prop": "extracts",
        "explaintext": True,
        "format": "json",
        "titles": title
    }
    res = requests.get(endpoint, params=params).json()
    page = next(iter(res['query']['pages'].values()))
    return page.get("extract", "")

def generate_fun_fact_from_wikipedia(title, max_chars=3000):
    """ChatGPTã‚’ä½¿ã£ã¦é¢ç™½ã„ã‚¨ãƒ”ã‚½ãƒ¼ãƒ‰ã‚’æŠ½å‡ºãƒ»ç”Ÿæˆ"""
    content = get_wikipedia_content(title)
    if not content:
        return f"{title} ã®Wikipediaæœ¬æ–‡ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚"

    truncated_content = content[:max_chars]
    prompt = f"""
ä»¥ä¸‹ã¯ã€Œ{title}ã€ã«é–¢ã™ã‚‹Wikipediaã®è¨˜äº‹ã®å†…å®¹ã§ã™ã€‚

---æœ¬æ–‡ã“ã“ã‹ã‚‰---
{truncated_content}
---æœ¬æ–‡ã“ã“ã¾ã§---

ã“ã®äººç‰©ã«é–¢ã—ã¦ã€ä¸€èˆ¬ã®äººãŒã€Œã¸ã‡ï¼ã€ã¨æ€ã†ã‚ˆã†ãªé¢ç™½ã„ã‚¨ãƒ”ã‚½ãƒ¼ãƒ‰ã‚’ä¸€ã¤ã€ç°¡å˜ã«ç´¹ä»‹ã—ã¦ãã ã•ã„ã€‚
ã§ãã‚‹ã ã‘è¦ªã—ã¿ã‚„ã™ãã€çŸ­ãã¾ã¨ã‚ã¦ãã ã•ã„ã€‚
"""

    try:
        response = client.chat.completions.create(
            model="gpt-4",
            messages=[{"role": "user", "content": prompt}],
            temperature=0.7,
        )
        
        return response.choices[0].message.content
    except Exception as e:
        print(f"ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: {str(e)}")
        return f"{title} ã®ã‚¨ãƒ”ã‚½ãƒ¼ãƒ‰ç”Ÿæˆä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚"

# âœ… ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
if __name__ == "__main__":
    great_figures = [
        # æ—¥æœ¬äºº20äºº
        "è–å¾³å¤ªå­",
        "ç¹”ç”°ä¿¡é•·",
        "è±Šè‡£ç§€å‰",
        "å¾³å·å®¶åº·",
        "å‚æœ¬é¾é¦¬",
        "è¥¿éƒ·éš†ç››",
        "å‹æµ·èˆŸ",
        "ç¦æ²¢è«­å‰",
        "é‡å£è‹±ä¸–",
        "å¤ç›®æ¼±çŸ³",
        "æ£®é·—å¤–",
        "èŠ¥å·é¾ä¹‹ä»‹",
        "æœ¬ç”°å®—ä¸€éƒ",
        "æ¾ä¸‹å¹¸ä¹‹åŠ©",
        "é»’æ¾¤æ˜",
        "å®®å´é§¿",
        "åŒ—é‡ŒæŸ´ä¸‰éƒ",
        "æ¸‹æ²¢æ „ä¸€",
        "æ±éƒ·å¹³å…«éƒ",
        "ç¾ç©ºã²ã°ã‚Š",

        # å¤–å›½äºº30äºº
        "ã‚¤ã‚¨ã‚¹ãƒ»ã‚­ãƒªã‚¹ãƒˆ",
        "ãƒ ãƒãƒ³ãƒãƒ‰",
        "ä»é™€ï¼ˆã‚¬ã‚¦ã‚¿ãƒãƒ»ã‚·ãƒƒãƒ€ãƒ¼ãƒ«ã‚¿ï¼‰",
        "å­”å­",
        "ã‚¢ãƒªã‚¹ãƒˆãƒ†ãƒ¬ã‚¹",
        "ãƒ—ãƒ©ãƒˆãƒ³",
        "ã‚½ã‚¯ãƒ©ãƒ†ã‚¹",
        "ã‚¢ãƒ¬ã‚¯ã‚µãƒ³ãƒ‰ãƒ­ã‚¹å¤§ç‹",
        "ãƒ¦ãƒªã‚¦ã‚¹ãƒ»ã‚«ã‚¨ã‚µãƒ«",
        "ãƒŠãƒãƒ¬ã‚ªãƒ³ãƒ»ãƒœãƒŠãƒ‘ãƒ«ãƒˆ",
        "ã‚¢ãƒ–ãƒ©ãƒãƒ ãƒ»ãƒªãƒ³ã‚«ãƒ¼ãƒ³",
        "ã‚¸ãƒ§ãƒ¼ã‚¸ãƒ»ãƒ¯ã‚·ãƒ³ãƒˆãƒ³",
        "ã‚¦ã‚£ãƒ³ã‚¹ãƒˆãƒ³ãƒ»ãƒãƒ£ãƒ¼ãƒãƒ«",
        "ã‚¢ãƒ‰ãƒ«ãƒ•ãƒ»ãƒ’ãƒˆãƒ©ãƒ¼",
        "ãƒãƒãƒˆãƒãƒ»ã‚¬ãƒ³ãƒ‡ã‚£ãƒ¼",
        "ãƒãƒ«ã‚½ãƒ³ãƒ»ãƒãƒ³ãƒ‡ãƒ©",
        "ã‚«ãƒ¼ãƒ«ãƒ»ãƒãƒ«ã‚¯ã‚¹",
        "ãƒ¬ãƒ¼ãƒ‹ãƒ³",
        "ãƒˆãƒ¼ãƒã‚¹ãƒ»ã‚¨ã‚¸ã‚½ãƒ³",
        "ã‚¢ãƒ«ãƒ™ãƒ«ãƒˆãƒ»ã‚¢ã‚¤ãƒ³ã‚·ãƒ¥ã‚¿ã‚¤ãƒ³",
        "ã‚¢ã‚¤ã‚¶ãƒƒã‚¯ãƒ»ãƒ‹ãƒ¥ãƒ¼ãƒˆãƒ³",
        "ãƒãƒ£ãƒ¼ãƒ«ã‚ºãƒ»ãƒ€ãƒ¼ã‚¦ã‚£ãƒ³",
        "ãƒ‹ã‚³ãƒ©ãƒ»ãƒ†ã‚¹ãƒ©",
        "ãƒãƒªãƒ¼ãƒ»ã‚­ãƒ¥ãƒªãƒ¼",
        "ãƒ¢ãƒ¼ãƒ„ã‚¡ãƒ«ãƒˆ",
        "ãƒ¬ã‚ªãƒŠãƒ«ãƒ‰ãƒ»ãƒ€ãƒ»ãƒ´ã‚£ãƒ³ãƒ",
        "ãƒŸã‚±ãƒ©ãƒ³ã‚¸ã‚§ãƒ­",
        "ãƒ‘ãƒ–ãƒ­ãƒ»ãƒ”ã‚«ã‚½",
        "ãƒã‚¶ãƒ¼ãƒ»ãƒ†ãƒ¬ã‚µ",
        "ã‚¢ãƒ³ãƒãƒ»ãƒ•ãƒ©ãƒ³ã‚¯"
    ]

    name = great_figures[0]
    result = generate_fun_fact_from_wikipedia(name)
    print(f"\nğŸ“˜ {name} ã®é¢ç™½ã„ã‚¨ãƒ”ã‚½ãƒ¼ãƒ‰:\n{result}")
